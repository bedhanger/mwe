#!/usr/bin/env bash

# A fairly stringent firewall relying heavily on IP sets

# We'd like to know as much as we can.
common_log_options="\
   --log-level info \
   --log-tcp-seq \
   --log-tcp-options \
   --log-ip-options \
   --log-uid \
"
# Prevent logs from overflowing.
log_limit=3/m
log_burst=3

# Flush everything and begin anew sanely.
iptables --flush
iptables --delete-chain
iptables --policy INPUT DROP
iptables --policy OUTPUT DROP
iptables --policy FORWARD DROP

# Special chains to log & drop/accept packets indiscriminately.
iptables --new-chain LOGDROP
iptables --append LOGDROP \
   --match limit \
      --limit ${log_limit} \
      --limit-burst ${log_burst} \
   --jump LOG \
      --log-prefix "Dropping: " \
      ${COMMON_LOG_OPTIONS}
iptables --append LOGDROP --jump DROP

iptables --new-chain LOGACCEPT
iptables --append LOGACCEPT \
   --match limit \
      --limit ${log_limit} \
      --limit-burst ${log_burst} \
   --jump LOG \
      --log-prefix "Accepting: " \
      ${COMMON_LOG_OPTIONS}
iptables --append LOGACCEPT --jump ACCEPT

# Special chain to sever/reset a connection.
iptables --new-chain RJCTRST
iptables --append RJCTRST --protocol udp --jump REJECT \
   --reject-with icmp-port-unreachable
iptables --append RJCTRST --protocol tcp --jump REJECT \
   --reject-with tcp-reset

# The forwarding is very simple.
iptables --append FORWARD --jump RJCTRST

# What goes out must not be heading towards sites we eschew.
iptables --append OUTPUT \
   --match set \
      --match-set forbidden_sites dst \
   --jump RJCTRST
iptables --append OUTPUT --jump ACCEPT

# Incoming traffic is more complicated.  We need more chains
# first.

# Open up HTTPS for everyone.  Useful for mastering the ACME
# challenge when requesting a certificate (renewal).
# Only use this on an as-needed basis!
iptables --new-chains CERT-PUNCTURE
iptables --append CERT-PUNCTURE \
   --match limit \
      --limit ${log_limit} \
      --limit-burst ${log_burst} \
   --jump LOG \
      --log-prefix "Cert? " \
      ${COMMON_LOG_OPTIONS}
iptables --append CERT-PUNCTURE --protocol tcp \
   --destination-port https --jump ACCEPT
iptables --append CERT-PUNCTURE --jump RJCTRST
