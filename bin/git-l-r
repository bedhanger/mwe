#!/usr/bin/env bash

# A Git porcelain command to determine the left-right
# relationship between a branch and its upstream.

# Accepts branches as parameters, defaults to current one.

branches="${@}"

if [ -z "${branches}" ]
then

   branches="git symbolic-ref --short HEAD"
   if ! branches=$(${branches})
   then

      cat << EOM >&2
Cannot determine the name of your local branch
EOM
      # This is fatal.
      exit -1

   fi
fi

for this in ${branches}
do

   remote="git config --get branch.${this}.remote"
   if ! remote=$(${remote})
   then

      cat << EOM >&2
Cannot determine ${this}'s remote repository
EOM
      continue

   fi

   that="git config --get branch.${this}.merge"
   if ! that=$(${that})
   then

      cat << EOM >&2
Cannot determine the name of ${this}'s upstream branch
EOM
      continue

   fi

   that="eval perl -pe 's|refs/heads/||;' <<< ${that}"
   if ! that=$(${that})
   then

      cat << EOM >&2
Cannot normalise upstream branch's name
EOM
      continue

   fi

   # A sloppy name for what's known as the symmetric difference.
   this_n_that="${this}...${remote}/${that}"
   echo ${this_n_that}

   cmd="git log --left-right --oneline ${this_n_that}"
   if ! ${cmd}
   then

      cat << EOM >&2
Cannot determine relationship between ${this_n_that}
EOM
      continue

   fi

done
