#!/usr/bin/env bash

# A Git porcelain command to determine the left-right
# relationship in terms of which commits are where between a
# branch and its upstream.

# Accepts branches as parameters, defaults to current one.

Me=$(basename ${0})

Branches="${@}"
if [ -z "${Branches}" ]
then

   Branches="git symbolic-ref --short HEAD"
   if ! Branches=$(${Branches})
   then

      cat << EOM >&2
${Me}> Cannot determine the name of your local branch
EOM
      # This is fatal.
      exit -1

   fi
fi

for This in ${Branches}
do

   Remote="git config --get branch.${This}.remote"
   if ! Remote=$(${Remote})
   then

      cat << EOM >&2
${Me}> Cannot determine remote for ${This} branch
EOM
      continue

   fi

   URL="git config --get remote.${Remote}.url"
   if ! URL=$(${URL})
   then

      cat << EOM >&2
${Me}> Cannot determine URL for ${Remote}
EOM
      # Used for cosmetics only.  Carry on.
      URL="<could not be determined>"

   fi

   That="git config --get branch.${This}.merge"
   if ! That=$(${That})
   then

      cat << EOM >&2
${Me}> Cannot determine the name of upstream branch for ${This}
EOM
      continue

   fi

   That="eval perl -pe 's|refs/heads/||;' <<< ${That}"
   if ! That=$(${That})
   then

      cat << EOM >&2
${Me}> Cannot normalise name of upstream branch
EOM
      continue

   fi

   # A sloppy name for what's known as the symmetric difference.
   This_N_That="${This}...${Remote}/${That}"
   echo "${This_N_That} (from ${URL})"

   Cmd="git log --left-right --oneline ${This_N_That}"
   if ! ${Cmd}
   then

      cat << EOM >&2
${Me}> Cannot determine relationship for ${This_N_That}
EOM
      continue

   fi

done
