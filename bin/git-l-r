#!/usr/bin/env bash

# A Git porcelain command to determine the left-right
# relationship between a branch and its upstream.

# Accepts branches as parameters, defaults to current one.

BRANCHES="${@}"

if [ -z "${BRANCHES}" ]
then

   BRANCHES="git symbolic-ref --short HEAD"
   if ! BRANCHES=$(${BRANCHES})
   then

      cat << EOM >&2
Cannot determine the name of your local branch"
EOM
      exit -1

   fi

fi

for THIS in ${BRANCHES}
do

   REMOTE="git config --get branch.${THIS}.remote"
   if ! REMOTE=$(${REMOTE})
   then

      cat << EOM >&2
   Cannot find ${THIS}'s remote repository"
EOM
      continue

   fi

   THAT="git config --get branch.${THIS}.merge"
   if ! THAT=$(${THAT})
   then

      cat << EOM >&2
   Cannot determine the name of ${THIS}'s upstream branch"
EOM
      continue

   fi

   THAT="eval perl -pe 's|refs/heads/||;' <<< ${THAT}"
   if ! THAT=$(${THAT})
   then

      cat << EOM >&2
   Cannot normalise your upstream branch's name"
EOM
      continue

   fi

   THIS_N_THAT="${THIS}...${REMOTE}/${THAT}"

   CMD="git log --left-right --oneline ${THIS_N_THAT}"
   if ! ${CMD}
   then

      cat << EOM >&2
   Cannot determine relationship between ${THIS_N_THAT}
EOM
      continue

   fi

done
