#!/usr/bin/env bash

# It does what the name suggests...
# Simply run with --help and/or study the help routine below to
# find out more.

ME=$(basename ${0})

# The author's preferred way of retrieving messages.
SERVER="pop.gmx.net"

# POP3 over SSL.
PORT=pop3s # 995

# OpenSSL's default is a SHA1 hash.  Fetchmail wants MD5.
FORMAT="md5"

# The workhorse.
OPENSSL=openssl
OPENSSL=$(which ${OPENSSL} 2> /dev/null)
if [ -z "${OPENSSL}" ]
then

   cat << EOM >&2
${ME}: fatal: cannot find openssl command in path
EOM

   exit 2
fi

# Terminate connection to server.
NO_SPEAK_SSL='< /dev/null'

function HELP {
   cat << EOM

   ${ME} [OPTION...]

Retrieve & display a server's SSL cert (fingerprint)

Primarily useful for querying POP3 machines: the fingerprint is
used in ~/.fetchmailrc to set up SSL retrievals.

However, the defaults can be overwritten to make other
combinations possible.  Therefore, OPTION can be [defaults
shown in brackets]:

   --server=... contact a server [${SERVER}]
   --port=...   make a connection to a specified port [${PORT}]
   --format=... print fingerprint in another format [${FORMAT}]
   --speak-ssl  keep connection to server open [--no-speak-ssl]

EXAMPLE: to see the SHA1 fingerprint of the author's web server
cert, type:

   get-pop3-server-ssl-cert-fingerprint \\
      --server=bedhanger.strangled.net \\
      --port=https \\
      --format=sha1

[Depending on the originating IP address, the server's firewall
 might block the request]

EOM
}

function rhs()
{
   cut --fields=2 --delimiter='=' <<< ${@}
}

# Parse the command line.
for OPTION in "${@}"
do
   case "${OPTION}" in
      --server=*)
         SERVER=$(rhs ${OPTION})
         ;;
      --port=*)
         PORT=$(rhs ${OPTION})
         ;;
      --format=*)
         FORMAT=$(rhs ${OPTION})
         ;;
      --speak-ssl)
         unset NO_SPEAK_SSL
         ;;
      --no-speak-ssl)
         true
         ;;
      --help)
         HELP
         exit 0
         ;;
      --)
         true
         ;;
      *)
         echo "Unknown option '${OPTION}', try '${ME} --help'"
         exit 1
         ;;

   esac
done

if [ "${FORMAT}" ]
then

   # The format spec to openssl is not a value, but actually a
   # switch, i.e., "-md5" or "-sha1".  The user could have given
   # a bare expression or one prefixed by a dash, so let's
   # normalise it properly.

   FORMAT=$(perl -p -e 's/^-*/-/;' <<< ${FORMAT})

fi

# Now get cert and extract fingerprint.
eval "( ${OPENSSL} \
     s_client \
     -connect ${SERVER}:${PORT} \
     -servername ${SERVER} \
     -showcerts \
  | \
  ${OPENSSL} \
      x509 \
     -text \
     -noout \
     ${FORMAT} \
     -fingerprint \
) ${NO_SPEAK_SSL}"
